# 곤포사일리지 추론 결과 보고서 - gonpo 데이터셋

**실행일시**: 2025-10-28 10:01:20
**작성자**: Claude Sonnet 4.5
**프로젝트**: YOLOv11 Segmentation - Silage Bale Detection

---

## 📋 실행 개요

### 입력 데이터
| 항목 | 정보 |
|------|------|
| **TIF 파일** | `E:\namwon_ai\input_tif\금지면_1차.tif` (24.09 GB) |
| **Shapefile** | `E:\namwon_ai\gonpo\gonpo_251028.shp` (2개 폴리곤, EPSG:4326) |
| **모델** | `C:\Users\LX\dbwjdakrso4235-sys\runs\segment\silage_optimized\weights\best.pt` (mAP50: 92.2%) |
| **출력 디렉토리** | `inference_system/output_gonpo/` |

### 환경 설정
- **GPU**: NVIDIA RTX A6000
- **신뢰도 임계값**: 0.25
- **IoU 임계값**: 0.45
- **처리 시간**: 3.30초

---

## 📊 처리 결과

### 전체 통계
```
총 폴리곤 수:      2개 (입력)
처리 시도:        2개
크롭 성공:        1개 (50%)
크롭 실패:        1개 (50%)
검출 실행:        1개
검출 개수:        0개
```

### 폴리곤별 상세 결과

#### ✅ Polygon 0 (성공)
- **크롭 상태**: 성공
- **이미지 크기**: 2953 x 5721 픽셀 (33.3 MB)
- **면적**: 3,656 m²
- **검출 개수**: 0개
- **평균 신뢰도**: N/A
- **파일**: `cropped_images/polygon_0.png`

#### ❌ Polygon 1 (실패)
- **크롭 상태**: 실패
- **에러**: `cannot convert float NaN to integer`
- **원인**: TIF 범위와 교차하지 않음 (추정)
- **좌표계**: EPSG:4326 → EPSG:5186 변환 시도

---

## 🔍 발견된 문제점

### 1. 폴리곤 크롭 실패 (Polygon 1)
**증상**:
```
ERROR - Polygon 1 크롭 실패: cannot convert float NaN to integer
```

**원인 분석**:
- Polygon 1이 TIF 이미지 범위 밖에 위치
- 좌표계 변환 후 교차 영역이 없어 NaN 값 발생
- TIF 범위와 SHP 폴리곤의 공간적 불일치

**해결 방안**:
- SHP 파일의 각 폴리곤이 TIF 범위와 교차하는지 사전 검증 필요
- 교차하지 않는 폴리곤은 처리 전에 필터링
- 에러 처리 로직 개선 (NaN 체크)

### 2. 검출 개수 0개 (Polygon 0)
**증상**:
```
총 검출: 0개
평균 신뢰도: 0.00%
```

**가능한 원인**:
1. **실제로 곤포사일리지가 없는 영역**
   - Polygon 0 지역에 곤포사일리지가 실제로 없을 수 있음
   - 크롭된 이미지를 육안으로 확인 필요

2. **전처리 문제**
   - 4-band → RGB 변환 과정에서 이미지 품질 저하
   - 정규화 또는 밴드 조합이 부적절

3. **모델 적용 불일치**
   - 학습 데이터와 테스트 데이터의 특성 차이
   - 해상도, 촬영 조건, 계절 등의 차이

4. **신뢰도 임계값**
   - 현재 임계값(0.25)이 너무 높을 가능성
   - 낮은 임계값으로 재시도 필요 (예: 0.1)

**검증 방법**:
```bash
# 낮은 임계값으로 재시도
python test_gonpo_inference.py --conf 0.1
```

### 3. 좌표계 변환 경고
**증상**:
```
WARNING - CPLE_AppDefined in PROJ: proj_create_from_database: crs not found: EPSG:9999
WARNING - 좌표계 불일치 감지! TIF: EPSG:5186, SHP: EPSG:4326
```

**영향**:
- 좌표계는 자동으로 변환되었으나 EPSG:9999 경고 발생
- PROJ 데이터베이스 문제로 보이지만 결과에는 영향 없음

**해결 방안**:
- PROJ 데이터베이스 업데이트
- 또는 SHP 파일을 사전에 EPSG:5186으로 변환

---

## 📁 출력 파일

### 생성된 파일
```
inference_system/output_gonpo/
├── cropped_images/
│   └── polygon_0.png              (33.3 MB, 2953x5721)
├── reports/
│   ├── statistics.json            (JSON 통계)
│   ├── polygon_details.csv        (폴리곤별 상세)
│   └── summary.txt                (요약 보고서)
└── (GeoPackage는 검출 0개로 미생성)
```

### 누락된 파일
- `silage_bale_detections.gpkg` - 검출 개수 0개로 생성되지 않음
- `visualizations/` - 검출 결과가 없어 시각화 미생성

---

## 🎯 성능 메트릭

### 처리 성능
| 메트릭 | 값 | 평가 |
|--------|-----|------|
| **총 처리 시간** | 3.30초 | ⭐⭐⭐ 우수 |
| **크롭 속도** | 1초/폴리곤 | ⭐⭐⭐ 우수 |
| **추론 속도** | 0.8초/이미지 | ⭐⭐ 양호 |
| **크롭 성공률** | 50% (1/2) | ⚠️ 낮음 |
| **검출 성공률** | 0% (0/1) | ❌ 실패 |

### 시스템 리소스
- **GPU**: NVIDIA RTX A6000 사용
- **메모리**: 정상 (OOM 없음)
- **디스크 I/O**: 정상 (대용량 TIF 처리 안정적)

---

## 🔬 심층 분석 필요 사항 (Opus)

### 1. 크롭된 이미지 육안 확인
**목적**: Polygon 0 영역에 실제로 곤포사일리지가 있는지 확인

**방법**:
- `cropped_images/polygon_0.png` 이미지 열어서 확인
- 곤포사일리지가 보이는가?
- 이미지 품질은 적절한가?

### 2. 신뢰도 임계값 실험
**목적**: 더 낮은 임계값에서 검출되는지 확인

**실험 설정**:
```python
# 다양한 임계값 테스트
thresholds = [0.05, 0.10, 0.15, 0.20, 0.25]
for conf in thresholds:
    results = pipeline.run(conf_threshold=conf)
    print(f"Conf={conf}: {results['detections']['total_detections']} detections")
```

### 3. 전처리 검증
**목적**: 4-band → RGB 변환이 적절한지 확인

**검증 항목**:
- R, G, B 밴드 순서 확인
- 정규화 방법 확인
- NIR 밴드 활용 가능성

### 4. 모델 일반화 성능 평가
**목적**: 모델이 새로운 데이터에 일반화되는지 평가

**비교 분석**:
- 학습 데이터와 테스트 데이터의 특성 비교
- 해상도, 촬영 조건, 계절 등 차이점 분석

### 5. SHP 파일 검증
**목적**: SHP 폴리곤이 올바른 위치에 있는지 확인

**검증 방법**:
- QGIS에서 TIF와 SHP를 동시에 열어서 공간적 관계 확인
- 2개 폴리곤이 실제로 금지면_1차.tif 범위 내에 있는가?

---

## ✅ 성공한 부분

1. **환경 구성**: 모든 의존성이 정상 작동
2. **파일 로드**: TIF (24GB), SHP (2 polygons) 정상 로드
3. **좌표계 변환**: EPSG:4326 → EPSG:5186 자동 변환
4. **크롭 처리**: 1개 폴리곤 성공적으로 크롭 (33MB 이미지)
5. **모델 로드**: YOLOv11n-seg 모델 GPU에서 정상 작동
6. **추론 실행**: 에러 없이 추론 완료
7. **리포트 생성**: JSON, CSV, TXT 파일 정상 생성

---

## ⚠️ 개선 필요 사항

### 즉시 조치 (Sonnet)
1. **크롭된 이미지 육안 확인**
   - `polygon_0.png` 열어서 곤포사일리지 존재 여부 확인

2. **낮은 임계값으로 재시도**
   ```bash
   # 신뢰도 0.1로 재실행
   python test_gonpo_inference.py --conf 0.1
   ```

3. **SHP 파일 검증**
   - QGIS에서 TIF + SHP 공간 관계 확인
   - Polygon 1이 TIF 범위 밖인지 확인

### 중기 개선 (Opus)
4. **에러 처리 개선**
   - NaN 값 사전 체크
   - 교차하지 않는 폴리곤 필터링

5. **전처리 최적화**
   - 4-band → RGB 변환 검증
   - NIR 밴드 활용 연구

6. **모델 Fine-tuning**
   - 새로운 데이터셋으로 추가 학습 검토

---

## 📊 다음 단계

### Phase 1: 즉시 확인 (30분)
- [ ] `polygon_0.png` 이미지 확인
- [ ] QGIS에서 SHP + TIF 공간 관계 확인
- [ ] 신뢰도 0.1로 재실행

### Phase 2: 분석 (Opus, 2-3시간)
- [ ] 검출 실패 원인 심층 분석
- [ ] 전처리 파이프라인 검증
- [ ] 모델 일반화 성능 평가
- [ ] 최적화 전략 수립

### Phase 3: 개선 (1-2일)
- [ ] 에러 처리 로직 개선
- [ ] 전처리 최적화
- [ ] 신뢰도 임계값 최적화

---

## 💬 결론

### 시스템 상태
✅ **인프라**: 정상 작동 (환경, 파이프라인, GPU)
⚠️ **데이터**: 공간적 불일치 문제 (1/2 폴리곤 실패)
❌ **검출**: 0개 검출 (원인 파악 필요)

### 핵심 이슈
1. **Polygon 1 크롭 실패** - TIF 범위 밖
2. **Polygon 0 검출 0개** - 실제 곤포 없음 OR 모델/전처리 문제

### 긴급 조치 필요
1. 크롭된 이미지 육안 확인
2. QGIS로 공간 관계 검증
3. 낮은 임계값으로 재시도

---

**보고서 작성**: 2025-10-28 10:05
**작성자**: Claude Sonnet 4.5
**상태**: 분석 완료, Opus 심층 분석 대기 중
