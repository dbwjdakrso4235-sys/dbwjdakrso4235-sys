# 공간 중첩 문제 분석 결과

**분석일**: 2025-10-28
**분석자**: Claude Sonnet 4.5

---

## 🔍 문제 발견

### SHP 파일 CRS 메타데이터 오류

**증상**:
- Polygon 1 크롭 실패: `cannot convert float NaN to integer`
- 추론 시스템에서 좌표계 변환 후 inf 값 발생

**원인**:
```
SHP 파일의 CRS: EPSG:4326 (WGS84, 경위도)
실제 좌표값:     226124, 304758 (투영좌표계, 미터 단위)
```

**분석**:
- CRS 메타데이터는 EPSG:4326(경위도)로 저장됨
- 실제 좌표값은 EPSG:5186(투영좌표계) 값
- geopandas가 잘못된 CRS에서 변환 시도 → inf/NaN 발생

---

## ✅ 확인된 사실

### CRS 강제 수정 후 중첩 상태

```
파일:           E:\namwon_ai\gonpo\gonpo_251028.shp
올바른 CRS:     EPSG:5186 (Korea 2000 / Central Belt)
폴리곤 수:      2개

TIF 범위:       X: 225384.72 ~ 228125.87 m
                Y: 301742.00 ~ 306811.14 m

Polygon 0:      X: 226124.99 ~ 226179.62 m
                Y: 304758.63 ~ 304864.47 m
                면적: 3,656.09 m²
                중첩: 100% ✅

Polygon 1:      X: 227799.98 ~ 227862.54 m
                Y: 303214.54 ~ 303330.68 m
                면적: 4,860.95 m²
                중첩: 100% ✅
```

**결론**: 2개 폴리곤 모두 TIF 범위와 100% 중첩됨! ✅

---

## 🛠️ 해결 방안

### 방법 1: SHP 파일 수정 (권장)

CRS를 올바르게 수정한 SHP 파일 생성:

```python
import geopandas as gpd

# 원본 SHP 로드
shp = gpd.read_file(r"E:\namwon_ai\gonpo\gonpo_251028.shp")

# CRS 강제 설정
shp_fixed = shp.set_crs("EPSG:5186", allow_override=True)

# 저장
shp_fixed.to_file(r"E:\namwon_ai\gonpo\gonpo_251028_fixed.shp")
```

### 방법 2: 추론 파이프라인 수정

`inference_system/src/crop_processor.py`에서 CRS 강제 설정 옵션 추가:

```python
# crop_processor.py 수정
def __init__(self, tif_path, shp_path, force_crs=None):
    ...
    if force_crs:
        self.gdf = self.gdf.set_crs(force_crs, allow_override=True)
```

### 방법 3: 임시 수정 (빠른 테스트)

테스트 스크립트에서 SHP 로드 후 CRS 강제 설정:

```python
# test_gonpo_inference.py에서
import geopandas as gpd
shp = gpd.read_file(shp_path)
shp = shp.set_crs("EPSG:5186", allow_override=True)
shp.to_file(shp_path.replace('.shp', '_fixed.shp'))
# 그 후 _fixed.shp 사용
```

---

## 🚀 다음 단계

### 1단계: SHP 파일 수정 (5분)
```bash
python fix_shp_crs.py
```

### 2단계: 추론 재실행 (3분)
```bash
python inference_system\examples\test_gonpo_inference.py
```

### 3단계: 결과 확인
- 2개 폴리곤 모두 크롭 성공 예상 ✅
- 검출 개수 확인 (곤포사일리지 존재 여부)

---

## 📊 예상 결과

### 크롭 성공률
- **현재**: 1/2 (50%)
- **수정 후**: 2/2 (100%) ✅

### 검출 개수
- Polygon 0: 이전과 동일 (0개 or X개)
- Polygon 1: **새로 처리됨** (0개 or X개)

---

## 🔬 추가 조사 필요

Polygon 0에서 검출이 0개였던 이유:
1. 실제로 곤포사일리지가 없는 영역
2. 신뢰도 임계값이 너무 높음
3. 전처리 문제
4. 모델 일반화 문제

→ 크롭된 이미지(`polygon_0.png`) 육안 확인 필요

---

## 💡 권장 조치

### 즉시 실행 (Sonnet)
1. ✅ CRS 문제 발견
2. ⏳ SHP 파일 CRS 수정
3. ⏳ 추론 재실행
4. ⏳ 결과 비교

### 심층 분석 (Opus)
1. 검출 0개 원인 분석
2. 신뢰도 임계값 최적화
3. 전처리 파이프라인 검증

---

**결론**: SHP 파일의 CRS 메타데이터 오류가 근본 원인이었습니다.
수정 후 재실행하면 정상 작동할 것으로 예상됩니다.
