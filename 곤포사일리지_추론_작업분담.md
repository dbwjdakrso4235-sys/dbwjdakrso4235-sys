# 곤포사일리지 추론 프로젝트 작업 분담

**작성일**: 2025-10-28
**프로젝트**: 곤포사일리지 추론 - gonpo SHP + TIF 크롭핑 처리
**상태**: 준비 단계

---

## 📊 프로젝트 현황

### 데이터 정보
| 구분 | 경로 | 상태 | 비고 |
|------|------|------|------|
| **TIF 파일** | `E:\namwon_ai\input_tif\금지면_1차.tif` | ✅ | 24.09 GB |
| **SHP 파일** | `E:\namwon_ai\gonpo\gonpo_251028.shp` | ✅ | 2개 폴리곤, EPSG:4326 |
| **모델 파일** | `C:\Users\LX\dbwjdakrso4235-sys\runs\segment\silage_optimized\weights\best.pt` | ✅ | 5.8 MB, mAP50: 92.2% |
| **추론 시스템** | `inference_system/` | ✅ | 완전 구현됨 |

### 환경 설정 상태
- ✅ Python 3.10.11
- ✅ PyTorch 2.7.1+cu118 (CUDA 11.8)
- ✅ Ultralytics 8.3.219
- ✅ OpenCV 4.12.0
- ✅ rasterio 1.4.3
- ✅ geopandas 1.1.1

---

## 🎯 작업 목표

새로운 데이터셋으로 곤포사일리지 추론 시스템 테스트
- **입력**: `E:\namwon_ai\gonpo\gonpo_251028.shp` (2개 폴리곤)
- **처리**: `E:\namwon_ai\input_tif\금지면_1차.tif` (24.09 GB) 크롭
- **출력**: GeoPackage + 시각화 + 통계 보고서

---

## 👥 역할 분담

### 🔵 Claude Sonnet 담당 업무

#### Phase 1: 환경 검증 및 데이터 준비 (우선순위: 높음)

**1. 학습된 모델 파일 확인 및 준비**
- [ ] 프로젝트 폴더에서 best.pt 파일 위치 확인
  - 예상 경로: `runs/segment/silage_optimized/weights/best.pt`
  - 또는 다른 학습 결과 폴더 확인
- [ ] 모델 파일이 없는 경우:
  - 옵션 1: 기존 학습된 모델 위치 사용자에게 확인
  - 옵션 2: YOLOv11n-seg pre-trained 모델 다운로드
  - 옵션 3: 새로 학습 (시간 소요)
- [ ] 모델 로드 테스트
  ```python
  from ultralytics import YOLO
  model = YOLO('path/to/best.pt')
  print(model.names)  # 클래스 확인
  ```

**2. 데이터 검증**
- [x] SHP 파일 로드 및 구조 확인 ✅
  - 2개 폴리곤, EPSG:4326
- [x] TIF 파일 크기 확인 ✅
  - 24.09 GB
- [ ] TIF와 SHP 교차 영역 확인
  ```python
  # TIF 범위와 SHP 폴리곤이 겹치는지 확인
  from crop_processor import CropProcessor
  processor = CropProcessor(
      tif_path=r"E:\namwon_ai\input_tif\금지면_1차.tif",
      shp_path=r"E:\namwon_ai\gonpo\gonpo_251028.shp"
  )
  print(processor.get_statistics())
  ```

**3. 추론 스크립트 실행 준비**
- [ ] `inference_system/examples/run_inference.py` 수정
  - TIF 경로: `E:\namwon_ai\input_tif\금지면_1차.tif`
  - SHP 경로: `E:\namwon_ai\gonpo\gonpo_251028.shp`
  - 모델 경로: (확인된 경로 입력)
  - 출력 경로: `inference_system/output_gonpo`
- [ ] 테스트 실행 스크립트 작성
  ```python
  # test_gonpo_inference.py
  from inference_system.src.pipeline import SilageBaleDetectionPipeline

  pipeline = SilageBaleDetectionPipeline(
      tif_path=r"E:\namwon_ai\input_tif\금지면_1차.tif",
      shp_path=r"E:\namwon_ai\gonpo\gonpo_251028.shp",
      model_path="path/to/best.pt",
      output_dir="inference_system/output_gonpo"
  )

  # 2개 폴리곤 전체 처리
  stats = pipeline.run(polygon_ids=None)
  print(stats)
  ```

#### Phase 2: 추론 실행 및 모니터링 (우선순위: 높음)

**4. 소규모 테스트 (2개 폴리곤)**
- [ ] 첫 번째 폴리곤만 처리 (테스트)
  ```bash
  python test_gonpo_inference.py --limit 1
  ```
- [ ] 처리 시간 측정
  - 크롭 시간
  - 추론 시간
  - 총 처리 시간
- [ ] 에러 로그 확인
- [ ] 메모리 사용량 모니터링

**5. 전체 폴리곤 처리**
- [ ] 2개 폴리곤 전체 처리
- [ ] 실시간 진행 상황 모니터링
- [ ] GPU 사용률 확인
- [ ] 처리 중 에러 발생 시 즉시 보고

#### Phase 3: 결과 정리 및 문서화 (우선순위: 중간)

**6. 결과 파일 확인**
- [ ] GeoPackage 파일 생성 확인
  - `inference_system/output_gonpo/silage_bale_detections.gpkg`
- [ ] 시각화 이미지 확인
  - `inference_system/output_gonpo/visualizations/`
- [ ] 통계 보고서 확인
  - `statistics.json`
  - `polygon_details.csv`
  - `summary.txt`

**7. 기본 결과 분석**
- [ ] 검출 개수 집계
  - 폴리곤별 검출 개수
  - 총 검출 개수
- [ ] 신뢰도 통계
  - 평균/최소/최대 신뢰도
- [ ] 처리 성능 정리
  - 처리 시간
  - 처리 속도 (폴리곤/분)
  - 메모리 사용량

**8. 결과 리포트 작성**
- [ ] 실행 로그 정리
- [ ] 결과 요약 문서 작성
  ```markdown
  # 곤포사일리지 추론 결과 (gonpo 데이터)

  ## 실행 정보
  - 날짜: 2025-10-28
  - TIF: 금지면_1차.tif (24.09 GB)
  - SHP: gonpo_251028.shp (2개 폴리곤)
  - 모델: best.pt (mAP50: ?%)

  ## 처리 결과
  - 성공 폴리곤: X/2
  - 총 검출 개수: X
  - 평균 신뢰도: X.XX
  - 처리 시간: X분 X초

  ## 에러 및 이슈
  - (발생한 이슈 기록)
  ```

**9. 시각화 자료 생성**
- [ ] 검출 결과 스크린샷
- [ ] 통계 그래프 생성 (선택)
- [ ] QGIS에서 GeoPackage 확인 (선택)

---

### 🔴 Claude Opus 담당 업무

#### Phase 1: 전략 수립 및 설계 (Sonnet 결과 후)

**1. 결과 심층 분석**
- [ ] Sonnet이 제공한 결과 검토
- [ ] 검출 성능 평가
  - Precision/Recall 추정
  - False Positive/Negative 분석
- [ ] 실패 케이스 원인 분석
  - 왜 검출 실패했는가?
  - 어떤 패턴에서 오검출이 발생하는가?

**2. 성능 메트릭 분석**
- [ ] 처리 속도 분석
  - 병목 지점 식별 (크롭 vs 추론)
  - 메모리 효율성 평가
- [ ] 최적화 가능성 평가
  - GPU 활용률 분석
  - 배치 처리 개선 여지
- [ ] 확장성 평가
  - 100개 폴리곤 처리 시간 예상
  - 1,000개 폴리곤 처리 전략

**3. 개선 방향 제시**
- [ ] 모델 성능 개선
  - Fine-tuning 필요성 판단
  - Post-processing 전략 (형태학적 연산)
  - 신뢰도 임계값 조정 제안
- [ ] 시스템 최적화
  - 멀티스레딩 도입 검토
  - 메모리 최적화 방안
  - 배치 크기 조정

#### Phase 2: 고급 최적화 (우선순위: 중간)

**4. 성능 최적화 전략 수립**
- [ ] GPU 메모리 최적화
  - FP16 추론 적용 검토
  - 동적 배치 크기 조정
- [ ] 처리 파이프라인 최적화
  - 비동기 I/O 도입
  - 병렬 처리 구조 설계
- [ ] 캐싱 전략
  - TIF 메타데이터 캐싱
  - 중간 결과 재사용

**5. 대규모 처리 전략**
- [ ] 100+ 폴리곤 처리 계획
  - 배치 처리 최적 크기
  - 체크포인트 시스템 설계
  - 실패 복구 메커니즘
- [ ] 리소스 관리 전략
  - 메모리 임계값 설정
  - GPU 메모리 모니터링
  - OOM 방지 전략

**6. 품질 보증 체계**
- [ ] 검증 지표 정의
  - 검출 정확도 측정 방법
  - Ground truth 확보 방안
- [ ] 자동 품질 체크
  - 이상치 검출 (너무 많은/적은 검출)
  - 신뢰도 분포 이상 탐지

#### Phase 3: 프로덕션 준비 (우선순위: 낮음)

**7. 배포 전략 수립**
- [ ] API 서버 아키텍처 설계
  - FastAPI 기반 REST API
  - 비동기 작업 큐 (Celery)
  - 결과 스토리지 설계
- [ ] Docker 컨테이너화 계획
  - Dockerfile 설계
  - 의존성 관리
  - GPU 지원 설정

**8. 모델 최적화 로드맵**
- [ ] ONNX 변환 가능성 검토
- [ ] TensorRT 최적화 전략
- [ ] 성능 vs 정확도 trade-off 분석

**9. 모니터링 시스템 설계**
- [ ] 메트릭 수집 전략
  - 처리 시간, 처리량
  - 에러율, 성공률
- [ ] 알림 시스템 설계
  - 처리 완료 알림
  - 에러 발생 알림

---

## 📅 작업 일정 (예상)

### Week 1: 테스트 실행 (Sonnet)
- Day 1: 모델 확인 및 환경 설정
- Day 2-3: 소규모 테스트 (1-2개 폴리곤)
- Day 4: 전체 처리 (2개 폴리곤)
- Day 5: 결과 정리 및 리포트 작성

### Week 2: 분석 및 최적화 계획 (Opus)
- Day 1-2: 결과 심층 분석
- Day 3-4: 최적화 전략 수립
- Day 5: 개선 계획 문서화

---

## 🔄 협업 워크플로우

```
1. Sonnet: 모델 파일 위치 확인
   ↓
2. Sonnet: 데이터 검증 (TIF + SHP 교차 확인)
   ↓
3. Sonnet: 추론 스크립트 수정 및 테스트
   ↓
4. Sonnet: 1개 폴리곤 테스트 실행
   ↓ (성공 시)
5. Sonnet: 2개 폴리곤 전체 처리
   ↓
6. Sonnet: 결과 정리 및 기본 분석
   ↓ (결과 전달)
7. Opus: 심층 분석 및 성능 평가
   ↓
8. Opus: 최적화 전략 수립
   ↓
9. Opus: 개선 방향 제시
   ↓ (전략 전달)
10. Sonnet: 최적화 구현 (필요 시)
```

---

## 🚨 즉시 에스컬레이션 상황

Sonnet이 다음 상황에서 Opus로 즉시 에스컬레이션:

1. **모델 파일을 찾을 수 없는 경우**
   - 어디에서 모델을 가져와야 하는가?
   - 새로 학습해야 하는가?

2. **TIF와 SHP가 교차하지 않는 경우**
   - 좌표계 변환 전략 필요
   - 데이터 재확인 필요

3. **메모리 부족 에러 발생**
   - 크롭 크기 조정 필요
   - 처리 방식 변경 필요

4. **추론 결과가 이상한 경우**
   - 검출 개수가 0개 또는 과도하게 많음
   - 신뢰도가 비정상적으로 낮음

---

## 📋 체크리스트

### Sonnet 시작 전 확인사항
- [ ] Python 환경 활성화
- [ ] GPU 사용 가능 확인
- [ ] TIF 파일 접근 가능 확인
- [ ] SHP 파일 접근 가능 확인
- [ ] 출력 디렉토리 생성 가능 확인
- [ ] 충분한 디스크 공간 (최소 10GB)

### Sonnet 실행 중 모니터링
- [ ] 크롭 성공률
- [ ] 추론 성공률
- [ ] GPU 메모리 사용률
- [ ] 처리 시간 (폴리곤당)
- [ ] 에러 로그

### Opus 분석 전 확인사항
- [ ] Sonnet의 전체 결과 수령
- [ ] GeoPackage 파일 다운로드
- [ ] 통계 보고서 확인
- [ ] 시각화 이미지 확인

---

## 📞 커뮤니케이션

### Sonnet → 사용자
- 진행 상황 정기 보고 (30분마다)
- 에러 발생 시 즉시 보고
- 중요 의사결정 필요 시 확인 요청

### Opus → 사용자
- 분석 결과 요약
- 개선 제안서
- 다음 단계 실행 계획

---

## 🎯 성공 기준

### Phase 1 (Sonnet)
- ✅ 2개 폴리곤 모두 처리 성공
- ✅ GeoPackage 파일 생성
- ✅ 시각화 이미지 생성
- ✅ 통계 보고서 생성
- ✅ 에러 없이 완료

### Phase 2 (Opus)
- ✅ 성능 메트릭 정량 분석
- ✅ 최적화 방안 3가지 이상 제시
- ✅ 대규모 처리 전략 수립
- ✅ 개선 로드맵 작성

---

**최종 수정**: 2025-10-28
**관리**: Claude Sonnet 4.5
**프로젝트**: YOLOv11 Segmentation - Silage Bale Detection
