# 하이퍼파라미터 최적화 전략

**작성일**: 2025-10-22
**프로젝트**: YOLOv11 Segmentation - Silage Bale Detection

---

## 1. 데이터셋 분석 기반 최적화

### 1.1 데이터셋 특성
```yaml
총 이미지: 324개 (작은 데이터셋)
총 객체: 970개
이미지당 평균 객체: ~3개
클래스 수: 1 (단일 클래스)
원본 해상도: 1024x1024
데이터 분할:
  - Train: 259 (79.9%)
  - Val: 32 (9.9%)
  - Test: 33 (10.2%)
```

### 1.2 주요 고려사항
1. **작은 데이터셋** → 과적합 위험 높음
2. **단일 클래스** → Classification loss 중요도 낮음
3. **고해상도** → 큰 이미지 크기 필요
4. **적은 샘플** → 강력한 augmentation 필수

---

## 2. 최적화 전략

### 2.1 모델 선택
```
작은 데이터셋 → 작은 모델 선호 (과적합 방지)

추천 순서:
1. yolo11n-seg (nano) - 첫 baseline, 가장 빠름
2. yolo11s-seg (small) - nano보다 성능 좋음, 적당한 속도
3. yolo11m-seg (medium) - 더 높은 성능 필요 시

권장하지 않음:
- yolo11l-seg, yolo11x-seg (데이터셋 대비 과도)
```

### 2.2 Learning Rate 전략
```yaml
# Baseline (nano)
lr0: 0.001            # 작은 LR로 시작 (안정성)
lrf: 0.01             # 1%까지 감소
cos_lr: true          # Cosine scheduler (부드러운 학습)
warmup_epochs: 3      # 처음 3 epoch warmup

# Advanced (small)
lr0: 0.0008           # 더 큰 모델은 더 작은 LR
warmup_epochs: 5      # 더 긴 warmup
```

**선택 이유**:
- 작은 데이터셋 → 작은 LR 필요
- Cosine scheduler → 부드러운 수렴
- Warmup → 초기 불안정성 방지

### 2.3 배치 크기 최적화
```yaml
batch: 8              # 16 → 8

이유:
- 작은 데이터셋: 배치 크기 작을수록 더 많은 업데이트
- GPU 메모리: imgsz=1024이므로 작은 배치 필요
- Gradient noise: 작은 배치 = regularization 효과
```

### 2.4 이미지 크기
```yaml
imgsz: 1024           # 640 → 1024

이유:
- 원본 해상도: 1024x1024
- 객체 크기: 다양 (작은 객체 포함)
- 디테일 보존: 고해상도 유지 필요
- 성능 향상: 큰 이미지 = 더 나은 segmentation
```

---

## 3. 과적합 방지 전략

### 3.1 Regularization
```yaml
# Weight Decay
weight_decay: 0.001   # 0.0005 → 0.001 (강화)

# Dropout (추가)
dropout: 0.1          # nano
dropout: 0.15         # small

# Label Smoothing (추가)
label_smoothing: 0.05  # nano
label_smoothing: 0.08  # small
```

### 3.2 Early Stopping
```yaml
patience: 100         # 50 → 100

이유:
- 작은 데이터셋은 수렴이 느림
- 충분한 patience로 최적점 찾기
```

### 3.3 Data Augmentation 강화

#### A. HSV Augmentation
```yaml
hsv_h: 0.02           # 색상 변화
hsv_s: 0.8            # 채도 변화
hsv_v: 0.5            # 명도 변화
```
**효과**: 다양한 조명/날씨 조건 시뮬레이션

#### B. Geometric Augmentation
```yaml
degrees: 10.0         # 회전 (-10° ~ +10°)
translate: 0.15       # 이동 (±15%)
scale: 0.7            # 크기 (0.3 ~ 1.7배)
shear: 5.0            # 전단 변환
perspective: 0.0005   # 원근 변환
fliplr: 0.5           # 좌우 뒤집기
flipud: 0.0           # 위아래 뒤집기 (항공 이미지는 안함)
```
**효과**: 다양한 시점/위치의 객체 학습

#### C. Advanced Augmentation
```yaml
mosaic: 1.0           # 4장 합성
mixup: 0.15           # 이미지 혼합 (15%)
copy_paste: 0.3       # 객체 복사-붙여넣기 (30%)
```
**효과**:
- Mosaic: 다양한 객체 배치 학습
- Mixup: Regularization
- Copy-paste: 객체 인스턴스 증가 (작은 데이터셋에 매우 효과적!)

### 3.4 Close Mosaic
```yaml
close_mosaic: 20      # 마지막 20 epoch

이유:
- 초기: Mosaic으로 다양성 학습
- 후기: 원본 이미지로 fine-tuning
```

---

## 4. Loss Weight 조정

### 4.1 단일 클래스 최적화
```yaml
box: 7.5              # Box loss (default)
seg: 2.5              # Segmentation loss (default)
cls: 0.5              # Class loss (낮춤)
```

**이유**:
- 단일 클래스 → classification 중요도 낮음
- Box + Seg에 집중

### 4.2 고급 설정
```yaml
# Advanced (small 모델)
seg: 3.0              # Segmentation 강조
```

---

## 5. 학습 일정

### 5.1 Epoch 수
```yaml
# Baseline (nano)
epochs: 150

# Advanced (small)
epochs: 200
```

**이유**:
- 작은 데이터셋은 더 많은 epoch 필요
- patience=100으로 early stopping 보장

### 5.2 Checkpoint 저장
```yaml
save_period: 10       # 10 epoch마다 저장
```

---

## 6. 설정 파일 비교

### 6.1 Baseline (nano)
- **목적**: 빠른 실험, 과적합 최소화
- **파일**: `configs/train_optimized.yaml`
- **특징**:
  - yolo11n-seg
  - epochs: 150
  - lr0: 0.001
  - moderate augmentation

### 6.2 Advanced (small)
- **목적**: 더 높은 성능
- **파일**: `configs/train_advanced.yaml`
- **특징**:
  - yolo11s-seg
  - epochs: 200
  - lr0: 0.0008
  - strong augmentation
  - EMA 활성화

---

## 7. 실험 순서

### Phase 1: Baseline
```bash
# 1. Nano 모델로 빠른 실험
python scripts/train.py \
  --data E:/namwon_ai/dataset_silage_bale_rgb/dataset.yaml \
  --model n \
  --epochs 150 \
  --batch 8 \
  --imgsz 1024 \
  --lr0 0.001 \
  --name silage_baseline

목표: mAP50 > 0.75
```

### Phase 2: 설정 파일 사용
```bash
# 2. 최적화 설정으로 학습
yolo segment train data=configs/train_optimized.yaml

목표: mAP50 > 0.80
```

### Phase 3: Advanced (필요 시)
```bash
# 3. Small 모델로 성능 향상
yolo segment train data=configs/train_advanced.yaml

목표: mAP50 > 0.85
```

---

## 8. 하이퍼파라미터 튜닝 팁

### 8.1 학습 중 모니터링
```bash
# TensorBoard 실행
tensorboard --logdir runs/segment

확인 사항:
- Loss 감소 추세
- mAP 증가 추세
- Train/Val gap (과적합 체크)
```

### 8.2 조정 가이드

**Loss가 수렴하지 않으면**:
- Learning rate 낮추기 (0.001 → 0.0005)
- Batch size 줄이기
- Warmup epochs 늘리기

**과적합이 발생하면**:
- Weight decay 높이기
- Dropout 높이기
- Augmentation 강화 (mixup, copy_paste 증가)
- 더 작은 모델 사용

**mAP가 낮으면**:
- 더 큰 모델 시도 (n → s)
- imgsz 확인 (1024 유지)
- Augmentation 조정
- Epoch 늘리기

**학습이 느리면**:
- AMP 활성화 (이미 활성화됨)
- Workers 조정
- Batch size 키우기 (GPU 메모리 허용 시)

---

## 9. 최종 권장 설정

### 첫 실험 (추천)
```yaml
파일: configs/train_optimized.yaml
모델: yolo11n-seg
Epochs: 150
Batch: 8
ImgSz: 1024
LR: 0.001
Augmentation: Strong (mixup=0.15, copy_paste=0.3)
```

**예상 결과**:
- 학습 시간: ~6-8시간 (GPU 의존)
- mAP50: 0.75-0.85
- 과적합: 최소화됨

### 성능 개선 필요 시
```yaml
파일: configs/train_advanced.yaml
모델: yolo11s-seg
Epochs: 200
더 강한 regularization + augmentation
```

---

## 10. 참고 자료

### YOLOv11 하이퍼파라미터
- [Ultralytics Docs - Hyperparameters](https://docs.ultralytics.com/guides/hyperparameter-tuning/)
- [YOLOv11 Segmentation](https://docs.ultralytics.com/tasks/segment/)

### Augmentation 연구
- Mosaic Augmentation: YOLOv4 paper
- Copy-Paste Augmentation: Simple Copy-Paste is a Strong Data Augmentation Method
- Mixup: mixup: Beyond Empirical Risk Minimization

---

**최종 수정**: 2025-10-22
**작성자**: Sonnet (Hyperparameter Optimization Specialist)
