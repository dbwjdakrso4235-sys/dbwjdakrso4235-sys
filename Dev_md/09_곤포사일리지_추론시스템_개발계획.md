# 곤포사일리지 추론 시스템 개발 계획

**작성일**: 2025-10-23
**프로젝트**: YOLOv11 Segmentation - Silage Bale Detection
**목적**: SHP 기반 TIF 이미지 크롭 및 곤포사일리지 자동 검출 시스템 구축

---

## 📋 프로젝트 개요

### 목표
- **기존 시스템 분석**: `E:/namwon_ai/saryo4model` 참조 모델 분석
- **SHP 기반 크롭**: shapefile로 정의된 영역만 분석하여 처리 효율 극대화
- **대용량 TIF 처리**: 25GB+ TIF 파일을 타일 기반으로 안정적 처리
- **자동화 파이프라인**: TIF + SHP → Crop → Inference → GeoPackage 변환

### 입력 데이터
| 구분 | 경로 | 설명 |
|------|------|------|
| **TIF 이미지** | `E:/namwon_ai/input_tif/금지면_1차.tif` | 25.8GB, 4-band (R,G,B,NIR) |
| **Shapefile** | `E:/namwon_ai/saryo_jeongbo/saryo_4m.shp` | 사료작물 필지 경계 정보 |
| **학습 모델** | `runs/segment/silage_optimized/weights/best.pt` | mAP50 92.2% |

### 출력 데이터
- **GeoPackage**: 검출된 곤포사일리지 폴리곤 (좌표계 보존)
- **시각화 이미지**: 검출 결과 오버레이 이미지
- **통계 리포트**: 필지별 검출 개수 및 면적

---

## 🏗️ 시스템 아키텍처

### 1. 참조 모델 분석 (saryo4model)

#### 핵심 컴포넌트
```python
# saryo4model/src/inference_tif.py
class Pipeline:
    - TileProcessor: 타일 생성 및 병합
    - PostProcessor: 형태학적 후처리
    - YOLOInference: YOLO 모델 추론
    - SimpleCache: 처리 결과 캐싱
```

#### 주요 특징
1. **타일 기반 처리**
   - 타일 크기: 1024x1024
   - 중첩 비율: 50% (경계 문제 해결)
   - 가중치 맵: 가우시안 가중치로 부드러운 병합

2. **메모리 관리**
   - 배치 처리: 8개 타일씩
   - 메모리 제한: 16GB
   - 캐싱: 처리 결과 재사용

3. **후처리 파이프라인**
   - Morphological operations (closing, opening)
   - Small object removal (min: 100 pixels)
   - Gaussian smoothing (sigma: 1.0)
   - Hole filling

#### 적용 가능 기술
| 기술 | saryo4model | 곤포사일리지 시스템 | 변경 사항 |
|------|-------------|---------------------|----------|
| **타일 처리** | ✅ 1024x1024 | ✅ 1024x1024 | 동일 |
| **중첩** | ✅ 50% | ✅ 50% | 동일 |
| **클래스** | 4개 (IRG, 호밀, 옥수수, 수단그라스) | 1개 (곤포사일리지) | 단순화 |
| **후처리** | ✅ 형태학 + 평활화 | ✅ 동일 | 동일 |
| **출력** | GeoPackage | GeoPackage | 동일 |
| **SHP 크롭** | ❌ 없음 | ✅ **새로 구현** | **추가** |

---

## 🔧 구현 계획

### Phase 1: 프로젝트 구조 생성
```
dbwjdakrso4235-sys/
├── inference_system/
│   ├── src/
│   │   ├── crop_processor.py      # SHP 기반 크롭 처리 (NEW)
│   │   ├── tile_processor.py      # 타일 생성/병합 (from saryo4model)
│   │   ├── inference_engine.py    # YOLO 추론 (adapted)
│   │   ├── postprocessor.py       # 후처리 (from saryo4model)
│   │   └── pipeline.py            # 통합 파이프라인 (NEW)
│   ├── configs/
│   │   └── inference_config.yaml  # 설정 파일
│   ├── tests/
│   │   ├── test_crop.py
│   │   └── test_inference.py
│   └── examples/
│       └── run_inference.py
└── Dev_md/
    └── 09_곤포사일리지_추론시스템_개발계획.md (본 문서)
```

### Phase 2: SHP 기반 크롭 모듈 (NEW)

#### 2.1 CropProcessor 클래스
```python
class CropProcessor:
    """Shapefile 기반 TIF 이미지 크롭 처리"""

    def __init__(self, tif_path: str, shp_path: str):
        self.tif_path = tif_path
        self.shp_path = shp_path
        self.gdf = None
        self.tif_src = None

    def load_data(self):
        """TIF 및 SHP 데이터 로드"""
        - rasterio로 TIF 열기
        - geopandas로 SHP 로드
        - 좌표계 일치 확인 (CRS 변환)

    def crop_by_polygon(self, polygon_id: int):
        """특정 폴리곤 영역만 크롭"""
        - polygon bounds 계산
        - rasterio.mask.mask() 사용
        - 4-band → 3-band RGB 변환
        - 메모리 효율적 처리

    def batch_crop(self):
        """모든 폴리곤 배치 크롭"""
        - 멀티스레딩 지원
        - 진행률 표시
        - 결과 캐싱
```

#### 2.2 기술적 고려사항
1. **좌표계 (CRS) 처리**
   ```python
   # TIF와 SHP의 CRS가 다를 경우 자동 변환
   if tif_crs != shp_crs:
       gdf = gdf.to_crs(tif_crs)
   ```

2. **대용량 파일 처리**
   ```python
   # 25GB TIF를 메모리에 올리지 않고 부분 읽기
   with rasterio.open(tif_path) as src:
       window = from_bounds(*bounds, src.transform)
       data = src.read(window=window)
   ```

3. **4-band → RGB 변환**
   ```python
   # 기존 utils/preprocess.py 재사용
   from utils.preprocess import convert_4band_to_rgb
   rgb_image = convert_4band_to_rgb(tile_data)
   ```

### Phase 3: 추론 엔진 적응

#### 3.1 InferenceEngine 클래스 (saryo4model 기반)
```python
class InferenceEngine:
    """곤포사일리지 전용 YOLO 추론 엔진"""

    def __init__(self, model_path: str, config: dict):
        self.model = YOLO(model_path)
        self.config = config
        self.tile_processor = TileProcessor(config)
        self.postprocessor = PostProcessor(config)

    def predict_cropped_region(self, image: np.ndarray):
        """크롭된 영역 추론"""
        - 타일 생성 (1024x1024, 50% overlap)
        - 배치 추론 (batch_size=8)
        - 타일 병합 (가중치 기반)
        - 후처리 (morphology)

    def process_polygon(self, polygon_id: int, cropped_image: np.ndarray):
        """폴리곤별 처리"""
        - 추론 실행
        - 결과 변환 (mask → polygon)
        - GeoPackage 저장
```

#### 3.2 설정 파일
```yaml
# configs/inference_config.yaml
model:
  path: "runs/segment/silage_optimized/weights/best.pt"
  device: "cuda"

inference:
  conf_threshold: 0.25
  iou_threshold: 0.45
  batch_size: 8

tile:
  size: 1024
  overlap: 0.5
  min_size: 512

postprocess:
  min_area_pixels: 100
  kernel_size: 5
  smoothing_sigma: 1.0

output:
  format: "gpkg"
  save_visualization: true
  save_statistics: true
```

### Phase 4: 통합 파이프라인

#### 4.1 Pipeline 클래스
```python
class SilageBaleDetectionPipeline:
    """통합 파이프라인: TIF + SHP → 추론 → GeoPackage"""

    def __init__(self, config_path: str):
        self.config = load_config(config_path)
        self.crop_processor = CropProcessor(...)
        self.inference_engine = InferenceEngine(...)

    def run(self):
        """전체 파이프라인 실행"""
        1. SHP 로드 및 폴리곤 리스트 생성
        2. 각 폴리곤에 대해:
           a. TIF 크롭
           b. RGB 변환
           c. 타일 기반 추론
           d. 결과 병합
           e. GeoPackage 저장
        3. 전체 통계 집계
        4. 최종 보고서 생성
```

#### 4.2 실행 예제
```python
# examples/run_inference.py
from inference_system.src.pipeline import SilageBaleDetectionPipeline

pipeline = SilageBaleDetectionPipeline(
    tif_path="E:/namwon_ai/input_tif/금지면_1차.tif",
    shp_path="E:/namwon_ai/saryo_jeongbo/saryo_4m.shp",
    model_path="runs/segment/silage_optimized/weights/best.pt",
    config_path="configs/inference_config.yaml"
)

results = pipeline.run()
```

---

## 👥 작업 분담: Sonnet vs Opus

### 🎯 Claude Sonnet (현재 세션) - 시스템 설계 및 핵심 구현

#### 담당 업무
1. **시스템 아키텍처 설계** ✅
   - saryo4model 분석 완료
   - 프로젝트 구조 설계 완료
   - 기술 스택 선정 완료

2. **핵심 모듈 구현**
   - `crop_processor.py`: SHP 기반 TIF 크롭 처리
   - `tile_processor.py`: saryo4model의 TileProcessor 적응
   - `pipeline.py`: 통합 파이프라인 구축

3. **설정 및 유틸리티**
   - `inference_config.yaml`: 설정 파일
   - 기존 `utils/preprocess.py` 통합
   - 에러 처리 및 로깅

4. **문서화**
   - 개발 계획서 작성 (본 문서)
   - API 문서 작성
   - 사용 가이드 작성

#### 우선순위
| 순위 | 작업 | 예상 시간 | 중요도 |
|------|------|----------|--------|
| 1 | CropProcessor 구현 | 2시간 | 🔴 Critical |
| 2 | TileProcessor 적응 | 1시간 | 🔴 Critical |
| 3 | Pipeline 통합 | 1.5시간 | 🔴 Critical |
| 4 | 설정 파일 작성 | 0.5시간 | 🟡 High |
| 5 | 문서화 | 1시간 | 🟡 High |

### 🚀 Claude Opus - 테스트 및 최적화

#### 담당 업무
1. **추론 엔진 최적화**
   - `inference_engine.py`: YOLO 추론 최적화
   - `postprocessor.py`: 후처리 파이프라인 튜닝
   - GPU 메모리 최적화
   - 배치 처리 효율화

2. **테스트 및 검증**
   - 단위 테스트 작성 (`tests/`)
   - 통합 테스트
   - 성능 벤치마킹
   - 엣지 케이스 처리

3. **실제 데이터 테스트**
   - `금지면_1차.tif` (25.8GB) 처리
   - `saryo_4m.shp` (196KB, ~1,000개 폴리곤) 처리
   - 메모리 사용량 모니터링
   - 처리 속도 측정

4. **성능 개선**
   - 멀티스레딩 최적화
   - 캐싱 전략 개선
   - 대용량 파일 처리 안정성 향상

#### 우선순위
| 순위 | 작업 | 예상 시간 | 중요도 |
|------|------|----------|--------|
| 1 | InferenceEngine 구현 | 2시간 | 🔴 Critical |
| 2 | PostProcessor 적응 | 1시간 | 🔴 Critical |
| 3 | 실제 데이터 테스트 | 2시간 | 🔴 Critical |
| 4 | 성능 벤치마킹 | 1시간 | 🟡 High |
| 5 | 최적화 및 튜닝 | 2시간 | 🟡 High |

### 🤝 협업 지점

#### 인터페이스 정의 (공통)
```python
# 모듈 간 데이터 전달 형식
@dataclass
class CroppedRegion:
    polygon_id: str
    image: np.ndarray  # RGB, shape=(H, W, 3)
    bounds: tuple      # (minx, miny, maxx, maxy)
    transform: Affine  # rasterio transform
    crs: CRS           # 좌표계

@dataclass
class InferenceResult:
    polygon_id: str
    masks: Dict[int, np.ndarray]  # class_id -> binary mask
    polygons: List[Polygon]       # shapely polygons
    count: int                    # 검출 개수
    total_area: float             # 총 면적 (m²)
```

#### 통합 테스트 (공동)
- Sonnet이 구현한 크롭 모듈 → Opus가 구현한 추론 엔진
- 전체 파이프라인 통합 테스트
- 성능 목표: 1,000개 폴리곤 처리 < 2시간

---

## 📊 성능 목표

### 처리 속도
| 지표 | 목표 | 근거 |
|------|------|------|
| **크롭 속도** | 50개/분 | rasterio는 빠른 부분 읽기 지원 |
| **추론 속도** | 11.3ms/타일 | 기존 테스트 결과 |
| **전체 파이프라인** | 1,000개 폴리곤 < 2시간 | 평균 7.2초/폴리곤 |

### 메모리 사용
| 구분 | 제한 | 전략 |
|------|------|------|
| **RAM** | < 16GB | 타일 기반 처리, 배치 처리 |
| **GPU VRAM** | < 8GB | batch_size=8, FP16 지원 |

### 정확도
| 지표 | 목표 | 근거 |
|------|------|------|
| **mAP50** | > 90% | 학습 모델 92.2% |
| **검출률** | > 95% | 테스트 세트 97% |
| **False Positives** | < 5% | Precision 96.5% |

---

## 🧪 테스트 계획

### 1. 단위 테스트 (Opus)
```python
# tests/test_crop.py
def test_crop_single_polygon():
    """단일 폴리곤 크롭 테스트"""
    processor = CropProcessor(tif_path, shp_path)
    result = processor.crop_by_polygon(polygon_id=0)
    assert result.image.shape[2] == 3  # RGB
    assert result.bounds is not None

def test_coordinate_transform():
    """좌표계 변환 테스트"""
    # EPSG:5186 → EPSG:4326 변환 확인
```

### 2. 통합 테스트 (공동)
```python
# tests/test_pipeline.py
def test_end_to_end():
    """전체 파이프라인 테스트"""
    pipeline = SilageBaleDetectionPipeline(...)
    results = pipeline.run()

    assert len(results) > 0
    assert all(r.count >= 0 for r in results)
    assert output_gpkg.exists()
```

### 3. 성능 테스트 (Opus)
```python
# tests/test_performance.py
def test_processing_speed():
    """처리 속도 벤치마킹"""
    import time

    start = time.time()
    pipeline.process_polygon(polygon_id=0)
    elapsed = time.time() - start

    assert elapsed < 10.0  # 10초 이내
```

### 4. 실제 데이터 테스트 (Opus)
- **입력**: `금지면_1차.tif` (25.8GB)
- **SHP**: `saryo_4m.shp` (~1,000개 폴리곤)
- **예상 소요 시간**: 2시간
- **메모리 모니터링**: psutil로 실시간 모니터링

---

## 📈 마일스톤

### Week 1: 핵심 구현 (Sonnet + Opus)
- [ ] Day 1-2: CropProcessor 구현 및 테스트 (Sonnet + Opus)
- [ ] Day 3-4: InferenceEngine 구현 (Opus)
- [ ] Day 5-6: Pipeline 통합 (Sonnet)
- [ ] Day 7: 단위 테스트 작성 (Opus)

### Week 2: 테스트 및 최적화 (Opus 주도)
- [ ] Day 1-2: 실제 데이터 테스트 (금지면_1차.tif)
- [ ] Day 3-4: 성능 최적화 및 버그 수정
- [ ] Day 5-6: 문서화 및 사용 가이드 (Sonnet)
- [ ] Day 7: 최종 검증 및 배포 준비

---

## 📚 기술 스택

### 핵심 라이브러리
```
# 지리공간 데이터 처리
rasterio>=1.4.0      # TIF 파일 처리
geopandas>=0.14.0    # Shapefile 처리
shapely>=2.0.0       # 기하학 연산
fiona>=1.9.0         # Shapefile I/O

# YOLO 및 컴퓨터 비전
ultralytics>=8.3.0   # YOLOv11
opencv-python>=4.12.0
Pillow>=11.0.0

# 수치 계산
numpy>=2.1.0
scipy>=1.14.0
scikit-image>=0.24.0

# 유틸리티
tqdm>=4.67.0         # 진행률 표시
psutil>=6.1.0        # 메모리 모니터링
pyyaml>=6.0.0        # 설정 파일
```

---

## 🔍 리스크 및 대응

### 1. 대용량 파일 처리 (25.8GB TIF)
**리스크**: 메모리 부족, 처리 시간 과다
**대응**:
- rasterio의 window 읽기로 필요한 부분만 로드
- 타일 기반 처리로 메모리 사용 분산
- 캐싱으로 재처리 방지

### 2. 좌표계 불일치
**리스크**: TIF와 SHP의 CRS가 다를 경우 크롭 실패
**대응**:
- 자동 CRS 감지 및 변환
- 에러 로깅 및 사용자 알림
- 수동 CRS 지정 옵션 제공

### 3. 폴리곤 개수 과다 (~1,000개)
**리스크**: 처리 시간 2시간 초과
**대응**:
- 멀티스레딩/멀티프로세싱
- 배치 처리 최적화
- 진행률 표시 및 중단/재개 기능

### 4. False Positive 발생
**리스크**: 곤포사일리지가 아닌 객체 검출
**대응**:
- Confidence threshold 조정 (0.25 → 0.35)
- 후처리 강화 (area filter, shape filter)
- 사용자 검토 인터페이스 제공

---

## 📝 보고서 업데이트 계획

### 추가할 문서
1. **`10_SHP기반_크롭_기술문서.md`** (Sonnet)
   - CropProcessor 구현 상세
   - rasterio + geopandas 활용법
   - 좌표계 변환 예제

2. **`11_추론_파이프라인_최적화.md`** (Opus)
   - InferenceEngine 성능 분석
   - 타일 병합 알고리즘 설명
   - GPU 메모리 최적화 전략

3. **`12_실제데이터_테스트_결과.md`** (Opus)
   - 금지면_1차.tif 처리 결과
   - 처리 시간 및 메모리 사용량
   - 검출 정확도 분석

### 기존 문서 업데이트
- **`07_최종보고서_Final_Report.md`**
  - Section 8 추가: "곤포사일리지 추론 시스템"
  - 시스템 아키텍처 다이어그램
  - 성능 비교 (학습 vs 추론)

- **`08_향후계획_Future_Roadmap.md`**
  - 단기 계획에 "SHP 기반 추론 시스템 완성" 추가
  - 중기 계획에 "대용량 데이터 처리 최적화" 추가

---

## 🎯 성공 기준

### 기능적 요구사항
- [x] saryo4model 분석 완료
- [ ] SHP 기반 TIF 크롭 성공
- [ ] 크롭된 영역에서 곤포사일리지 검출 성공
- [ ] GeoPackage 형식으로 결과 저장
- [ ] 1,000개 폴리곤 처리 완료

### 비기능적 요구사항
- [ ] 처리 속도: 1,000개 폴리곤 < 2시간
- [ ] 메모리 사용: < 16GB RAM
- [ ] GPU 메모리: < 8GB VRAM
- [ ] 검출 정확도: mAP50 > 90%
- [ ] 에러 처리: 모든 예외 상황 로깅

### 문서화 요구사항
- [x] 개발 계획서 작성
- [ ] API 문서 작성
- [ ] 사용 가이드 작성
- [ ] 테스트 결과 보고서
- [ ] 최종 보고서 업데이트

---

## 📞 다음 단계

### Immediate (Sonnet - 현재 세션)
1. ✅ 개발 계획서 작성 완료
2. ⏭️ `crop_processor.py` 구현 시작
3. ⏭️ `tile_processor.py` saryo4model에서 적응
4. ⏭️ `pipeline.py` 통합 시작

### Next Session (Opus)
1. `inference_engine.py` 구현
2. `postprocessor.py` 구현
3. 통합 테스트 실행
4. 성능 벤치마킹

### Collaboration Point
- Sonnet이 CropProcessor 완성 후 Opus에게 인터페이스 전달
- Opus가 InferenceEngine 완성 후 통합 테스트
- 최종 파이프라인 공동 검증

---

**작성자**: Claude Sonnet 4.5
**검토자**: (Opus 세션에서 추가)
**최종 업데이트**: 2025-10-23
